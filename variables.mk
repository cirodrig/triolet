# This is a makefile, to be included by other makefiles.
# Variables are assigned here.

# Platform-specific settings generated by autoconf
include config.mk

# Source files and variables generated by cabal
include cabal.mk

## Convert parameters into command line option strings

C_PACKAGE_FLAGS=$(foreach pkg, $(C_PACKAGES), -package $(pkg))
L_PACKAGE_FLAGS=$(foreach pkg, $(L_PACKAGES), -package $(pkg))
LIB_FLAGS=$(foreach lib, $(LIBS), -l$(lib))

PYON_HS_INCLUDEDIR_FLAGS=\
  -isrc/program -i$(BUILDDIR)/pyon $(foreach dir, $(INCLUDEDIRS), -I$(dir))

CLAY_HS_INCLUDEDIR_FLAGS=\
  -isrc/program -isrc/rts \
  -i$(BUILDDIR)/pyon -i$(BUILDDIR)/rts \
  $(foreach dir, $(INCLUDEDIRS), -I$(dir))

C_INCLUDEDIR_FLAGS= $(foreach dir, $(INCLUDEDIRS), -I$(dir))

LIBDIR_FLAGS=$(foreach dir, $(LIBDIRS), -L$(dir))

## Aggregate parameters for specific commands
# TARGET_LANGUAGE_ACTION_OPTS

#PYON_HS_C_OPTS=$(HCFLAGS) -outputdir $(BUILDDIR)/pyon \
#  -XMultiParamTypeClasses -XGADTs $(PYON_HS_INCLUDEDIR_FLAGS) $(C_PACKAGE_FLAGS)

RTS_C_C_OPTS=$(CCFLAGS) -g \
 -Isrc/rts -I$(RTS_BUILD_DIR) -I$(DATA_BUILD_DIR)/include \
 $(C_INCLUDEDIR_FLAGS)

# Compile the RTS for dynamic linking.  RTS files will include the same header
# that compiled Pyon files will include; this file is found in the 'library'
# directory.
RTS_C_OPTS=-Ilibrary $(CCFLAGS) -dynamic

# Linker options used for the Pyon binary
# PYON_L_OPTS=$(LFLAGS) $(L_PACKAGE_FLAGS) $(LIBDIR_FLAGS) $(LIB_FLAGS)

# CLAY_L_OPTS=$(HCFLGS) $(LFLAGS) -outputdir $(BUILDDIR)/computelayout \
#  $(CLAY_HS_INCLUDEDIR_FLAGS) $(L_PACKAGE_FLAGS) $(LIBDIR_FLAGS) $(LIB_FLAGS)

## File lists

CLAY_SRCS=ComputeLayout.hs

CLAY_SOURCE_FILES=$(foreach src, $(CLAY_SRCS), $(SRCDIR)/rts/$(src))

PYON_SCRIPTS=pyon_testsuite pyon_compile
PYON_GENERATED_SCRIPTS=$(foreach src, $(PYON_SCRIPTS), build/scripts/$(src))

PYON_TARGET=$(BUILDDIR)/pyon/pyon
CLAY_TARGET=$(BUILDDIR)/computelayout/computelayout
RTS_TARGET=$(BUILDDIR)/rts/libpyonrts.so
